import java.sql.*;

public class DatabaseAccess extends Thread {
	Statement statement;
	
	static int numRequests = 1;
	
	static int percentRead = 0;
	static int percentInsert = 100;
	// percentUpdate is simply remaining amount

	// Credentials
	static String username = "basta";
	static String password = "Surface22";
	

	// JDBC URLs
	static String urlPSQL = "jdbc:postgresql://192.168.0.107:5432/netflix";
	static String urlMySQL = "jdbc:mysql://192.168.0.107:3306/netflix?allowPublicKeyRetrieval=true&useSSL=false";
	static String urlMonetDB = "jdbc:monetdb://192.168.0.107:1337/netflix";
	static String urlDB2 = "jdbc:db2://192.168.0.107:6969/netflix";
	
	static boolean canInsert = true;

	public void run() {
		try {
			System.out.println("here");
			Connection con = DriverManager.getConnection(urlMonetDB, username, password);
			statement = con.createStatement();

			for (int i = 0; i < numRequests; i++) {
				// Randomly choose an operation based on % probabilities
				int choice = (int) (Math.random() * 100); // Generate random number 0-99

				if (choice < percentRead) {
					executeRead();
				} else if (choice < percentRead + percentInsert) {
					while (canInsert == false) {
						
					}
					canInsert = false;
					executeInsert();
					canInsert = true;
				} else {
					while (canInsert == false) {
						
					}
					canInsert = false;
					executeUpdate();
					canInsert = true;				
				}
			}

			statement.close();
			con.close();
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// Randomly chooses read instruction to execute
	void executeRead() {
		int accid = (int) ((Math.random() * 2)); // Generate random number 0-1

		switch (accid) {
		case 0:
			getAvailableMedia();
			break;
		case 1:
			getNumEpisodes();
			break;
		}
	}

	// Randomly chooses insert instruction to execute
	void executeInsert() {
		int accid = (int) ((Math.random() * 1)); // Generate random number 0-1
		switch (accid) {
		case 0:
			createNewPayment();
			break;
		case 1:
			createAccount();
			break;
		}
	}

	// Randomly chooses update instruction to execute
	void executeUpdate() {
		int accid = (int) ((Math.random() * 1)); // Generate number 0-0 (Add more options for other projects)

		switch (accid) {
		case 0:
			increaseRockRatings();
			break;
		}
	}

	void getAvailableMedia() {
		int accid = (int) ((Math.random() * 10) + 1);
		
		try {
			// Create query
			String querySQL = "SELECT title, releaseYear FROM AccountUser au, available_in avail, Media med\r\n"
					+ "WHERE au.accid=" + accid
					+ " AND au.username=\'User\' AND avail.regname=au.regname AND med.mid=avail.mid;";

			// Execute query
			java.sql.ResultSet rs = statement.executeQuery(querySQL);

			// Uncomment to print results
			
			/*
			 * if (rs.next()) { System.out.println("Available Media:"); String name =
			 * rs.getString(1); int releaseYear = rs.getInt(2); System.out.println("	" +
			 * name + " (" + releaseYear + ")");
			 * 
			 * while (rs.next()) { name = rs.getString(1); releaseYear = rs.getInt(2);
			 * System.out.println("	" + name + " (" + releaseYear + ")"); } } else {
			 * System.out.println("No available media."); }
			 */
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
		}
	}

	void getNumEpisodes() {
		int seasonNum = (int) ((Math.random() * 10) + 1);

		try {
			// Create query
			String querySQL = "SELECT COUNT(*) \r\n" + "FROM Episode e, Media m\r\n"
					+ "WHERE e.mid=m.mid AND m.title=\'Pokemon\' AND e.seasonnum=" + seasonNum + ";";

			// Execute query
			java.sql.ResultSet rs = statement.executeQuery(querySQL);

			// Uncomment to print result
			/*
			 * rs.next(); int numEpisodes = rs.getInt(1);
			 * System.out.println("Number of episodes in season " + seasonNum + ": " +
			 * numEpisodes);
			 */
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
		}
	}

	void createNewPayment() {
		int accid = (int) ((Math.random() * 10) + 1);
		String date = "2020-01-01";
		Double amount = (double) ((int) (Math.random() * 100) + 1);

		while (true) {
			try {
				// Create insert string
				String insertSQL = "INSERT INTO Payment VALUES (DEFAULT, \'" + date + "\', " + amount + ", " + accid + ");";
	
				// Execute insert
				statement.executeUpdate(insertSQL);
	
				 System.out.println("Successfully added payment for account with ID #" + accid
				 + " on " + date + " for $" + amount + ".");
				 return;
			} catch (SQLException e) {
				String sqlMessage = e.getMessage();
				System.out.println(sqlMessage);
			}
		}
	}

	void createAccount() {
		while (true) {
			try {
				// Create insert string
				String insertSQL = "INSERT INTO Account VALUES (DEFAULT);";
				// Execute insert
				statement.executeUpdate(insertSQL);
	
				System.out.println("Successfully added account.");
				return;
			} catch (SQLException e) {
				String sqlMessage = e.getMessage();
				System.out.println(sqlMessage);
			}
		}
	}

	void increaseRockRatings() {
		try {
			// Create update string
			String updateSQL = "UPDATE Rating\r\n" + "SET value = value + 1\r\n" + "WHERE value <= 4 AND mid IN \r\n"
					+ "(\r\n" + "	SELECT mid\r\n" + "	FROM describes d, Tag t \r\n"
					+ "	WHERE d.tid=t.tid AND t.tagname='The Rock'\r\n" + ");";

			// Execute insert
			statement.executeUpdate(updateSQL);

			// System.out.println("Successfully increased ratings of all media with The Rock
			// in it by 1.");
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
		}
	}
}
