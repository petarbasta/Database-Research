import java.sql.*;

public class DatabaseAccess extends Thread {
	Statement statement;
	
	public void run() { 
		int percentGetAvailMedia = 20;
		int percentGetNumEpisodes = 20;
		int percentCreateNewPayment = 20;
		int percentCreateNextSeason = 20;
		int percentIncreaseRockRatings = 20;

		int numRequests = 100;
		
		try {
			// Set up connection
			Connection con;
			String usernamestring = "cs421g46";
			String passwordstring = "LuDaBa46";
			String url = "jdbc:postgresql://comp421.cs.mcgill.ca:5432/cs421";

			con = DriverManager.getConnection(url, usernamestring, passwordstring);
			statement = con.createStatement();
			
			for (int i=0; i<numRequests; i++) {
				int choice = (int)(Math.random() * 100);
				
				if (choice < percentGetAvailMedia) {
					getAvailableMedia();
					continue;
				}
				if (choice < percentGetAvailMedia + percentGetNumEpisodes) {
					getNumEpisodes();
					continue;
				}
				if (choice < percentGetAvailMedia + percentGetNumEpisodes + percentCreateNewPayment) {
					createNewPayment();
					continue;
				}
				if (choice < percentGetAvailMedia + percentGetNumEpisodes + percentCreateNewPayment + percentCreateNextSeason) {
					createNextSeason();
					continue;
				}
				if (choice < percentGetAvailMedia + percentGetNumEpisodes + percentCreateNewPayment + percentCreateNextSeason + percentIncreaseRockRatings) {
					increaseRockRatings();
					continue;
				}
			}
			
			statement.close();
			con.close();
		}
		catch (Exception e) {
			e.printStackTrace();
		}
    } 
	
	void getAvailableMedia() {
		int accid = (int)((Math.random() * 10)+1);;
		String username = "User";

		try {
			// Create query
			String querySQL = "SELECT title, releaseYear FROM accountuser au, available_in avail, media med\r\n"
					+ "WHERE au.accid=" + accid + " AND au.username=\'" + username
					+ "\' AND avail.regname=au.regname AND med.mid=avail.mid;";

			// Execute query
			java.sql.ResultSet rs = statement.executeQuery(querySQL);

			if (rs.next()) {
				System.out.println("Available Media:");
				String name = rs.getString(1);
				int releaseYear = rs.getInt(2);
				System.out.println("	" + name + " (" + releaseYear + ")");

				while (rs.next()) {
					name = rs.getString(1);
					releaseYear = rs.getInt(2);
					System.out.println("	" + name + " (" + releaseYear + ")");
				}
			} else {
				System.out.println("No available media.");
			}
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
		}
	}

	static void getNumEpisodes() {
		String title = "Pokemon";
		int seasonNum = (int)((Math.random() * 10)+1);

		try {
			// Create query
			String querySQL = "SELECT COUNT(*) \r\n" + "FROM episode e, media m\r\n"
					+ "WHERE e.mid=m.mid AND m.title=\'" + title + "\' AND e.seasonnum=" + seasonNum + ";";

			// Execute query
			java.sql.ResultSet rs = statement.executeQuery(querySQL);

			while (rs.next()) {
				int numEpisodes = rs.getInt(1);
				System.out.println("Number of episodes in season " + seasonNum + ": " + numEpisodes);
			}
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
		}
		System.out.println();
	}

	static void createNewPayment() {
		BufferedReader br = new BufferedReader(new InputStreamReader(System.in));
		int accid;
		String date;
		Double amount;

		System.out.println("(Try using account ID = 1 and date format YYYY-MM-DD)");

		// Get account ID
		System.out.print("Enter an account ID number: ");
		try {
			String s = br.readLine();
			accid = Integer.parseInt(s);
		} catch (Exception e) {
			System.out.println();
			System.out.println("Invalid input. Returning to main menu.");
			System.out.println();
			return;
		}
		
		// Get Date
		System.out.print("Enter a date: ");
		try {
			date = br.readLine();
		} catch (Exception e) {
			System.out.println();
			System.out.println("Invalid input. Returning to main menu.");
			System.out.println();
			return;
		}

		// Get amount
		System.out.print("Enter an amount: ");
		try {
			String s = br.readLine();
			System.out.println();
			amount = Double.parseDouble(s);
		} catch (Exception e) {
			System.out.println("Invalid input. Returning to main menu.");
			System.out.println();
			return;
		}

		try {
			// Create insert string
			String insertSQL = "INSERT INTO payment VALUES (DEFAULT, \'" + date + "\', " + amount + ", " + accid + ");";

			// Execute insert
			statement.executeUpdate(insertSQL);
			
			// If no error
			System.out.println("Successfully added payment for account with ID #" + accid + " on " + date + " for $" + amount + ".");
			System.out.println();
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
			System.out.println();
		}
	}
	
	static void createNextSeason() {
		BufferedReader br = new BufferedReader(new InputStreamReader(System.in));
		String title;
		String epTitle;
		int numSeasons;
		int mid;

		System.out.println("(Try using TV show = Pokemon)");

		// Get TV show title
		System.out.print("Enter a TV show title: ");
		try {
			title = br.readLine();
		} catch (Exception e) {
			System.out.println();
			System.out.println("Invalid input. Returning to main menu.");
			System.out.println();
			return;
		}
		
		// Get epTitle
		System.out.print("Your new season needs at least one episode. Enter an episode title: ");
		try {
			epTitle = br.readLine();
			System.out.println();
		} catch (Exception e) {
			System.out.println();
			System.out.println("Invalid input. Returning to main menu.");
			System.out.println();
			return;
		}
		
		try {
			// SEPARATE QUERIES SINCE SINGLE QUERY WON'T WORK IN CASE TV SHOW HAS 0 SEASONS
			
			// Create query for mid
			String querySQL = "SELECT mid \r\n" + 
					"FROM media \r\n" + 
					"WHERE title=\'" + title + "\';";

			// Execute query
			java.sql.ResultSet rs = statement.executeQuery(querySQL);
				
			// Get mid
			if (rs.next()) {
				mid = rs.getInt(1);
			}
			else {
				System.out.println("ERROR: Show does not exist.");
				System.out.println();
				return;
			}

			// Create query for numSeasons
			querySQL = "SELECT COUNT(*) \r\n" + 
					"FROM season s, media m \r\n" + 
					"WHERE s.mid=m.mid AND m.title=\'" + title + "\';";

			// Execute query
			rs = statement.executeQuery(querySQL);
			
			// Get numSeasons
			rs.next();
			numSeasons = rs.getInt(1);

			// Create insert string for season
			String insertSQL = "INSERT INTO season VALUES (" + (numSeasons+1) + ", " + mid + ");";
			// Execute insert
			statement.executeUpdate(insertSQL);
			
			// Create insert string for episode
			insertSQL = "INSERT INTO episode VALUES (1, " + (numSeasons+1) + ", " + mid + ", \'" + epTitle + "\');";
			// Execute insert
			statement.executeUpdate(insertSQL);
		
			// If no error
			System.out.println("Successfully added season " + (numSeasons+1) + " to " + title + " with first episode \"" + epTitle + "\".");
			System.out.println();
			
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
			System.out.println();
		}
	}
	
	static void increaseRockRatings() {
		try {
			// Create update string
			String updateSQL = "UPDATE rating\r\n" + 
					"SET value = value + 1\r\n" + 
					"WHERE value <= 4 AND mid IN \r\n" + 
					"(\r\n" + 
					"	SELECT mid\r\n" + 
					"	FROM describes d, tag t \r\n" + 
					"	WHERE d.tid=t.tid AND t.tagname='The Rock'\r\n" + 
					");";

			// Execute insert
			statement.executeUpdate(updateSQL);
			
			// If no error
			System.out.println("Successfully increased ratings of all media with The Rock in it by 1.");
			System.out.println();
		} catch (SQLException e) {
			String sqlMessage = e.getMessage();
			System.out.println(sqlMessage);
			System.out.println();
		}
	}

}
